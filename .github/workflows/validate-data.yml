name: Validate Data Sheet

on:
  push:
    paths:
      - '**.csv'
  pull_request:
    paths:
      - '**.csv'

permissions:
  contents: write

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch full history to ensure we have access to previous commits

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.0.0'

      - name: Install dependencies
        run: npm install

      - name: Run validation and revert on failure
        run: |
          if ! node validate.js; then
            echo "Validation failed. Reverting only CSV changes..."
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            
            # Debug: Show current commit info
            echo "Current commit: $(git rev-parse HEAD)"
            echo "Previous commit: $(git rev-parse HEAD^)"
            
            # Find CSV files that were changed in the last commit
            CSV_FILES=$(git diff --name-only HEAD^ HEAD | grep '\.csv$' || true)
            
            if [ -z "$CSV_FILES" ]; then
              echo "No CSV files found in last commit"
              # Show all files that changed for debugging
              echo "Files changed in last commit:"
              git diff --name-only HEAD^ HEAD
              exit 1
            fi
            
            echo "Reverting these CSV files:"
            echo "$CSV_FILES"
            
            # Revert only the CSV files to their previous state
            for file in $CSV_FILES; do
              echo "Reverting $file"
              git checkout HEAD^ -- "$file"
            done
            
            # Commit the reverted CSV files
            git add *.csv
            git commit -m "Revert CSV files due to validation failure"
            git push origin HEAD
            exit 1  # Fail the workflow
          fi